{% extends 'base.html' %}

{% block title %}{{ project.name }} - ì‚¬ì§„ ê´€ë¦¬{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <a href="{{ url_for('admin_dashboard') }}" style="color: var(--gray-500); text-decoration: none; font-size: 0.875rem;">
        â† ëŒ€ì‹œë³´ë“œ
    </a>
    <h1 style="font-size: 1.5rem; font-weight: 700; margin-top: 8px;">{{ project.name }}</h1>
</div>

<div class="stats">
    <div class="stat-item">
        <div class="stat-value">{{ project.photo_count }}</div>
        <div class="stat-label">ì „ì²´</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" style="color: var(--success);">{{ project.downloaded_count }}</div>
        <div class="stat-label">ë‹¤ìš´ë¡œë“œ</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" style="color: var(--warning);">{{ project.photo_count - project.downloaded_count }}</div>
        <div class="stat-label">ë¯¸ë‹¤ìš´ë¡œë“œ</div>
    </div>
</div>

{% if project.photos %}
    <div style="margin-bottom: 16px;">
        <a href="{{ url_for('admin_project_download_all', project_id=project.id) }}" class="btn btn-success btn-block">
            ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ZIP)
        </a>
    </div>
    
    {% for uploader_name, photos in uploaders.items() %}
        <div class="uploader-section">
            <div class="uploader-header">
                <div>
                    <span class="uploader-name">ğŸ‘¤ {{ uploader_name }}</span>
                    <span class="uploader-count">{{ photos|length }}ì¥</span>
                </div>
                <a href="{{ url_for('admin_uploader_download', project_id=project.id, uploader_name=uploader_name) }}" 
                   class="btn btn-outline btn-sm">
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
            
            <div class="photo-grid">
                {% for photo in photos %}
                    <div class="photo-thumb {{ 'downloaded' if photo.is_downloaded else '' }}" 
                         onclick="showPhoto({{ photo.id }}, '{{ photo.original_filename }}', {{ photo.is_downloaded|lower }})">
                        <img src="" data-photo-id="{{ photo.id }}" alt="{{ photo.original_filename }}" loading="lazy">
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="icon">ğŸ“·</div>
        <p>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
{% endif %}

<!-- ì‚¬ì§„ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal-backdrop" id="photoModal" style="display: none;" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <img src="" id="modalImage" alt="">
        <div style="padding: 16px; background: white;">
            <p id="modalFilename" style="font-weight: 600; margin-bottom: 4px;"></p>
            <p id="modalStatus" style="font-size: 0.875rem; color: var(--gray-500); margin-bottom: 16px;"></p>
            <div style="display: flex; gap: 8px;">
                <a href="" id="modalDownload" class="btn btn-primary btn-sm" style="flex: 1;">
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                </a>
                <form id="modalDeleteForm" method="POST" style="flex: 1;" 
                      onsubmit="return confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn btn-danger btn-sm btn-block">ì‚­ì œ</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ì¸ë„¤ì¼ ë¡œë“œ
document.querySelectorAll('.photo-thumb img').forEach(img => {
    const photoId = img.dataset.photoId;
    fetch(`/admin/photo/${photoId}/preview`)
        .then(res => res.json())
        .then(data => {
            if (data.url) {
                img.src = data.url;
            }
        });
});

function showPhoto(photoId, filename, isDownloaded) {
    const modal = document.getElementById('photoModal');
    const modalImg = document.getElementById('modalImage');
    const modalFilename = document.getElementById('modalFilename');
    const modalStatus = document.getElementById('modalStatus');
    const modalDownload = document.getElementById('modalDownload');
    const modalDeleteForm = document.getElementById('modalDeleteForm');
    
    // ì´ë¯¸ì§€ ë¡œë“œ
    fetch(`/admin/photo/${photoId}/preview`)
        .then(res => res.json())
        .then(data => {
            if (data.url) {
                modalImg.src = data.url;
            }
        });
    
    modalFilename.textContent = filename;
    modalStatus.textContent = isDownloaded ? 'âœ… ë‹¤ìš´ë¡œë“œë¨' : 'â³ ë¯¸ë‹¤ìš´ë¡œë“œ';
    modalDownload.href = `/admin/photo/${photoId}/download`;
    modalDeleteForm.action = `/admin/photo/${photoId}/delete`;
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeModal(event) {
    if (event.target.id === 'photoModal') {
        document.getElementById('photoModal').style.display = 'none';
        document.body.style.overflow = '';
    }
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.getElementById('photoModal').style.display = 'none';
        document.body.style.overflow = '';
    }
});
</script>
{% endblock %}
