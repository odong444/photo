{% extends 'base.html' %}
{% block title %}{{ project.name }} - ì‚¬ì§„ ê´€ë¦¬{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <a href="{{ url_for('admin_dashboard') }}" style="color: var(--gray-500); text-decoration: none; font-size: 0.875rem;">
        â† ëŒ€ì‹œë³´ë“œ
    </a>
    <h1 style="font-size: 1.5rem; font-weight: 700; margin-top: 8px;">{{ project.name }}</h1>
</div>

<div class="stats">
    <div class="stat-item">
        <div class="stat-value">{{ project.photo_count }}</div>
        <div class="stat-label">ì „ì²´</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" style="color: var(--success);">{{ project.downloaded_count }}</div>
        <div class="stat-label">ë‹¤ìš´ë¡œë“œ</div>
    </div>
    <div class="stat-item">
        <div class="stat-value" style="color: var(--warning);">{{ project.photo_count - project.downloaded_count }}</div>
        <div class="stat-label">ë¯¸ë‹¤ìš´ë¡œë“œ</div>
    </div>
</div>

{% if project.photos %}
    <!-- ì „ì²´ ë‹¤ìš´ë¡œë“œ -->
    <div style="margin-bottom: 16px;">
        <a href="{{ url_for('admin_project_download_all', project_id=project.id) }}" class="btn btn-success btn-block">
            ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ZIP)
        </a>
    </div>
    
    <!-- ì„ íƒ í•­ëª© ì•¡ì…˜ ë°” -->
    <div id="selectionBar" style="display: none; position: sticky; top: 0; background: var(--primary); color: white; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; z-index: 100;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span><strong id="selectedCount">0</strong>ê°œ ì„ íƒë¨</span>
            <div style="display: flex; gap: 8px;">
                <button onclick="downloadSelected()" class="btn btn-sm" style="background: white; color: var(--primary);">
                    ğŸ“¥ ì„ íƒ ë‹¤ìš´ë¡œë“œ
                </button>
                <button onclick="deleteSelected()" class="btn btn-sm" style="background: #ef4444; color: white;">
                    ğŸ—‘ ì„ íƒ ì‚­ì œ
                </button>
                <button onclick="clearSelection()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white;">
                    âœ• ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>
    
    <!-- ì „ì²´ ì„ íƒ -->
    <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <span style="font-size: 0.875rem; color: var(--gray-600);">ì „ì²´ ì„ íƒ</span>
        </label>
        <span style="font-size: 0.875rem; color: var(--gray-500);">ì‚¬ì§„ì„ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë³´ê¸°</span>
    </div>
    
    {% for uploader_name, photos in uploaders.items() %}
        <div class="uploader-section">
            <div class="uploader-header">
                <div>
                    <span class="uploader-name">ğŸ‘¤ {{ uploader_name }}</span>
                    <span class="uploader-count">{{ photos|length }}ì¥</span>
                </div>
                <a href="{{ url_for('admin_uploader_download', project_id=project.id, uploader_name=uploader_name) }}" 
                   class="btn btn-outline btn-sm">
                    ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
            
            <!-- ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ -->
            <div class="photo-grid">
                {% for photo in photos %}
                    <div class="photo-card {{ 'downloaded' if photo.is_downloaded else '' }}" data-photo-id="{{ photo.id }}">
                        <div class="photo-checkbox">
                            <input type="checkbox" class="photo-select" value="{{ photo.id }}" onchange="updateSelection()">
                        </div>
                        <div class="photo-thumb" onclick="openPreview('{{ photo.id }}', '{{ photo.original_filename }}')">
                            <img src="https://{{ s3_bucket }}.s3.{{ s3_region }}.amazonaws.com/{{ photo.filename }}" 
                                 alt="{{ photo.original_filename }}"
                                 loading="lazy">
                            {% if photo.is_downloaded %}
                                <div class="downloaded-badge">âœ“</div>
                            {% endif %}
                        </div>
                        <div class="photo-info">
                            <p class="photo-name" title="{{ photo.original_filename }}">{{ photo.original_filename }}</p>
                            <p class="photo-meta">{{ photo.file_size_display }} Â· {{ photo.uploaded_at.strftime('%m/%d %H:%M') }}</p>
                        </div>
                        <div class="photo-actions">
                            <a href="{{ url_for('admin_photo_download', photo_id=photo.id) }}" class="btn btn-primary btn-sm">ğŸ“¥</a>
                            <form action="{{ url_for('admin_photo_delete', photo_id=photo.id) }}" method="POST" style="display: inline;"
                                  onsubmit="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="empty-state">
        <div class="icon">ğŸ“·</div>
        <p>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </div>
{% endif %}

<!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="previewModal" class="modal" onclick="closePreview(event)">
    <div class="modal-content">
        <button class="modal-close" onclick="closePreview(event)">Ã—</button>
        <img id="previewImage" src="" alt="ë¯¸ë¦¬ë³´ê¸°">
        <p id="previewName" style="text-align: center; margin-top: 12px; color: white;"></p>
        <div style="text-align: center; margin-top: 12px;">
            <a id="previewDownload" href="" class="btn btn-primary">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</a>
        </div>
    </div>
</div>

<style>
.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 16px;
}

.photo-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    position: relative;
}

.photo-card.downloaded {
    border: 2px solid var(--success);
}

.photo-checkbox {
    position: absolute;
    top: 8px;
    left: 8px;
    z-index: 10;
}

.photo-checkbox input {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.photo-thumb {
    aspect-ratio: 1;
    overflow: hidden;
    cursor: pointer;
    position: relative;
    background: #f3f4f6;
}

.photo-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.2s;
}

.photo-thumb:hover img {
    transform: scale(1.05);
}

.downloaded-badge {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: var(--success);
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.photo-info {
    padding: 8px;
}

.photo-name {
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.photo-meta {
    font-size: 0.65rem;
    color: var(--gray-500);
}

.photo-actions {
    display: flex;
    gap: 4px;
    padding: 0 8px 8px;
}

.photo-actions .btn {
    flex: 1;
    padding: 6px;
    font-size: 0.75rem;
}

/* ëª¨ë‹¬ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
}

.modal-content img {
    max-width: 100%;
    max-height: 80vh;
    border-radius: 8px;
}

.modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    background: none;
    border: none;
    color: white;
    font-size: 2rem;
    cursor: pointer;
}

/* ì„ íƒ ìƒíƒœ */
.photo-card.selected {
    outline: 3px solid var(--primary);
}
</style>

<script>
let selectedPhotos = new Set();

function updateSelection() {
    selectedPhotos.clear();
    document.querySelectorAll('.photo-select:checked').forEach(cb => {
        selectedPhotos.add(cb.value);
        cb.closest('.photo-card').classList.add('selected');
    });
    document.querySelectorAll('.photo-select:not(:checked)').forEach(cb => {
        cb.closest('.photo-card').classList.remove('selected');
    });
    
    const bar = document.getElementById('selectionBar');
    const count = document.getElementById('selectedCount');
    
    if (selectedPhotos.size > 0) {
        bar.style.display = 'block';
        count.textContent = selectedPhotos.size;
    } else {
        bar.style.display = 'none';
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    document.querySelectorAll('.photo-select').forEach(cb => {
        cb.checked = selectAll;
    });
    updateSelection();
}

function clearSelection() {
    document.querySelectorAll('.photo-select').forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function downloadSelected() {
    if (selectedPhotos.size === 0) return;
    
    const ids = Array.from(selectedPhotos).join(',');
    window.location.href = '/admin/photos/download-selected?ids=' + ids;
}

function deleteSelected() {
    if (selectedPhotos.size === 0) return;
    
    if (!confirm(selectedPhotos.size + 'ê°œì˜ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/photos/delete-selected';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'ids';
    input.value = Array.from(selectedPhotos).join(',');
    
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

function openPreview(photoId, filename) {
    const img = document.querySelector(`[data-photo-id="${photoId}"] .photo-thumb img`);
    document.getElementById('previewImage').src = img.src;
    document.getElementById('previewName').textContent = filename;
    document.getElementById('previewDownload').href = '/admin/photo/' + photoId + '/download';
    document.getElementById('previewModal').classList.add('active');
}

function closePreview(event) {
    if (event.target.classList.contains('modal') || event.target.classList.contains('modal-close')) {
        document.getElementById('previewModal').classList.remove('active');
    }
}

// ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        document.getElementById('previewModal').classList.remove('active');
    }
});
</script>
{% endblock %}
