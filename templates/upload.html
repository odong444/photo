{% extends 'base.html' %}

{% block title %}{{ project.name }} - ì‚¬ì§„ ì—…ë¡œë“œ{% endblock %}

{% block content %}
<div style="margin-bottom: 24px;">
    <a href="{{ url_for('index') }}" style="color: var(--gray-500); text-decoration: none; font-size: 0.875rem;">
        â† í”„ë¡œì íŠ¸ ëª©ë¡
    </a>
    <h1 style="font-size: 1.5rem; font-weight: 700; margin-top: 8px;">{{ project.name }}</h1>
    {% if project.description %}
        <p style="color: var(--gray-500); margin-top: 4px;">{{ project.description }}</p>
    {% endif %}
</div>

<form method="POST" enctype="multipart/form-data" id="uploadForm">
    <div class="card">
        <div class="form-group">
            <label class="form-label">ì—…ë¡œë” ì´ë¦„ *</label>
            <input type="text" name="uploader_name" class="form-input" 
                   placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required
                   id="uploaderName">
        </div>
        
        <div class="form-group">
            <label class="form-label">ì‚¬ì§„ ì„ íƒ *</label>
            <div class="upload-area" id="uploadArea">
                <input type="file" name="photos" multiple accept="image/*" id="fileInput">
                <div class="upload-icon">ğŸ“·</div>
                <p class="upload-text">
                    <strong>í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ ì„ íƒ</strong><br>
                    <span style="font-size: 0.875rem;">ë˜ëŠ” íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸</span>
                </p>
            </div>
        </div>
        
        <div class="preview-list" id="previewList"></div>
        
        <div id="uploadProgress" style="display: none;">
            <p style="text-align: center; color: var(--gray-500); margin-bottom: 8px;">
                ì—…ë¡œë“œ ì¤‘... <span id="progressText">0%</span>
            </p>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary btn-block" id="submitBtn" disabled>
        ğŸ“¤ ì—…ë¡œë“œí•˜ê¸°
    </button>
</form>
{% endblock %}

{% block extra_js %}
<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const previewList = document.getElementById('previewList');
const submitBtn = document.getElementById('submitBtn');
const uploaderName = document.getElementById('uploaderName');
const uploadForm = document.getElementById('uploadForm');
const uploadProgress = document.getElementById('uploadProgress');

let selectedFiles = [];

// í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
uploadArea.addEventListener('click', () => fileInput.click());

// ë“œë˜ê·¸ ì•¤ ë“œë¡­
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

// íŒŒì¼ ì„ íƒ
fileInput.addEventListener('change', () => {
    handleFiles(fileInput.files);
});

function handleFiles(files) {
    for (let file of files) {
        if (file.type.startsWith('image/')) {
            selectedFiles.push(file);
        }
    }
    updatePreview();
    updateSubmitButton();
}

function updatePreview() {
    previewList.innerHTML = '';
    
    if (selectedFiles.length === 0) return;
    
    previewList.innerHTML = `
        <p style="font-weight: 600; margin-bottom: 12px;">
            ì„ íƒëœ ì‚¬ì§„ (${selectedFiles.length}ì¥)
        </p>
    `;
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const item = document.createElement('div');
            item.className = 'preview-item';
            item.innerHTML = `
                <img src="${e.target.result}" alt="">
                <span class="name">${file.name}</span>
                <span class="remove" onclick="removeFile(${index})">âœ•</span>
            `;
            previewList.appendChild(item);
        };
        reader.readAsDataURL(file);
    });
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
    updateSubmitButton();
}

function updateSubmitButton() {
    const hasName = uploaderName.value.trim() !== '';
    const hasFiles = selectedFiles.length > 0;
    submitBtn.disabled = !(hasName && hasFiles);
    
    if (hasFiles) {
        submitBtn.textContent = `ğŸ“¤ ${selectedFiles.length}ì¥ ì—…ë¡œë“œí•˜ê¸°`;
    } else {
        submitBtn.textContent = 'ğŸ“¤ ì—…ë¡œë“œí•˜ê¸°';
    }
}

uploaderName.addEventListener('input', updateSubmitButton);

// í¼ ì œì¶œ
uploadForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    if (selectedFiles.length === 0) return;
    
    const formData = new FormData();
    formData.append('uploader_name', uploaderName.value);
    
    selectedFiles.forEach(file => {
        formData.append('photos', file);
    });
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
    uploadProgress.style.display = 'block';
    
    const xhr = new XMLHttpRequest();
    
    xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = percent + '%';
        }
    });
    
    xhr.addEventListener('load', () => {
        window.location.href = xhr.responseURL;
    });
    
    xhr.addEventListener('error', () => {
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        submitBtn.disabled = false;
        submitBtn.textContent = `ğŸ“¤ ${selectedFiles.length}ì¥ ì—…ë¡œë“œí•˜ê¸°`;
        uploadProgress.style.display = 'none';
    });
    
    xhr.open('POST', '');
    xhr.send(formData);
});
</script>
{% endblock %}
